<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Unsubscribe from our newsletter">
    <title>Unsubscribe - Newsletter</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <!-- Background -->
    <div class="background-overlay" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>

    <!-- Main Content -->
    <main class="hero-container">
        <div class="hero-content">
            <h1 class="hero-title">Unsubscribe</h1>
            <p class="hero-subtitle">
                Sorry to see you go! Enter your email address to unsubscribe from our newsletter.
            </p>

            <!-- Unsubscribe Form -->
            <form id="unsubscribe-form" class="subscription-form" novalidate>
                <div id="message-container" role="alert" aria-live="polite"></div>

                <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        class="form-input"
                        placeholder="Enter your email address"
                        required
                        autocomplete="email"
                    >
                </div>

                <button type="submit" id="submit-btn" class="submit-btn" style="background: #ef4444;">
                    Unsubscribe
                </button>

                <p style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280; text-align: center;">
                    <a href="index.html" style="color: #2563eb; text-decoration: none;">
                        ‚Üê Back to Newsletter
                    </a>
                </p>
            </form>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('unsubscribe-form');
            const emailInput = document.getElementById('email');
            const submitBtn = document.getElementById('submit-btn');
            const messageContainer = document.getElementById('message-container');

            // Auto-fill email from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            const tokenParam = urlParams.get('token');

            if (emailParam) {
                emailInput.value = emailParam;
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const email = emailInput.value.trim();

                if (!email) {
                    showMessage('Email address is required.', 'error');
                    return;
                }

                if (!isValidEmail(email)) {
                    showMessage('Please enter a valid email address.', 'error');
                    return;
                }

                setLoading(true);

                try {
                    const response = await fetch('api/unsubscribe.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            token: tokenParam
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showMessage(data.message, 'success');
                        form.reset();
                    } else {
                        showMessage(data.message || 'Something went wrong. Please try again.', 'error');
                    }

                } catch (error) {
                    console.error('Unsubscribe error:', error);
                    showMessage('Something went wrong. Please try again later.', 'error');
                } finally {
                    setLoading(false);
                }
            });

            function showMessage(message, type) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${type}`;
                messageElement.textContent = message;
                messageContainer.innerHTML = '';
                messageContainer.appendChild(messageElement);
            }

            function setLoading(isLoading) {
                submitBtn.disabled = isLoading;
                submitBtn.classList.toggle('loading', isLoading);
                emailInput.disabled = isLoading;
            }

            function isValidEmail(email) {
                const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return regex.test(email) && email.length <= 254;
            }
        });
    </script>
</body>
</html>